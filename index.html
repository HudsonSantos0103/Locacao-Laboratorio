<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGE | EEEP Miguel Gurgel</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ===== VARIÁVEIS E RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary: #0f172a;
            --primary-light: #1e293b;
            --accent: #f59e0b;
            --accent-soft: rgba(245, 158, 11, 0.1);
            --accent-glow: rgba(245, 158, 11, 0.3);
            --bg-main: #f1f5f9;
            --bg-side: #ffffff;
            --bg-card: rgba(255, 255, 255, 0.8);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: rgba(0, 0, 0, 0.08);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius: 16px;
            --radius-sm: 12px;
            --transition: all 0.2s ease;
        }

        .dark-theme {
            --bg-main: #020617;
            --bg-side: #0f172a;
            --bg-card: rgba(15, 23, 42, 0.8);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
        }

        body {
            background: var(--bg-main);
            color: var(--text-main);
            transition: var(--transition);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* ===== TOAST ===== */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--bg-side);
            color: var(--text-main);
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: var(--shadow-md);
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 350px;
            border: 1px solid var(--border);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success { border-left-color: #10b981; }
        .toast-error { border-left-color: #ef4444; }
        .toast-warning { border-left-color: #f59e0b; }
        .toast-info { border-left-color: #3b82f6; }

        /* ===== TELA DE AUTENTICAÇÃO ===== */
        #auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at top left, #1e293b, #020617);
            padding: 1rem;
        }

        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: 24px;
            border: 1px solid var(--border);
            width: 100%;
            max-width: 440px;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo-box {
            width: 50px;
            height: 50px;
            background: var(--accent);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-weight: 800;
            margin: 0 auto 1rem;
        }

        .input-field {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.8rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
        }

        .input-field:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .input-field input,
        .input-field select {
            background: transparent;
            border: none;
            outline: none;
            color: inherit;
            width: 100%;
            font-size: 0.95rem;
        }

        .input-field select {
            cursor: pointer;
        }

        .eye-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 1.2rem;
        }

        .btn-primary-glow {
            width: 100%;
            padding: 1rem;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 0 20px var(--accent-glow);
            color: #000;
            font-size: 1rem;
        }

        .btn-primary-glow:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px var(--accent-glow);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            padding: 0.6rem 1.2rem;
            border-radius: 10px;
            color: var(--text-main);
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-outline:hover {
            background: var(--bg-main);
        }

        .auth-footer {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.9rem;
        }

        .auth-footer a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        /* ===== DASHBOARD LAYOUT ===== */
        #dashboard {
            display: none;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: var(--bg-side);
            height: 100vh;
            position: fixed;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 2rem 1rem;
            z-index: 1000;
            transition: var(--transition);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 1rem 2.5rem;
        }

        .logo-sm {
            background: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 800;
        }

        .nav-link {
            background: transparent;
            border: none;
            padding: 0.8rem 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 12px;
            cursor: pointer;
            color: var(--text-muted);
            font-weight: 500;
            transition: var(--transition);
            margin-bottom: 0.3rem;
            width: 100%;
            text-align: left;
        }

        .nav-link i {
            font-size: 1.2rem;
        }

        .nav-link:hover {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .nav-link.active {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .sidebar-footer {
            margin-top: auto;
            display: flex;
            gap: 10px;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .btn-icon {
            background: var(--bg-main);
            border: 1px solid var(--border);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            color: var(--text-main);
            transition: var(--transition);
        }

        .btn-icon:hover {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .main-content {
            margin-left: 260px;
            padding: 2.5rem 3.5rem;
            min-height: 100vh;
            transition: var(--transition);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }

        .page-info h1 {
            font-size: 2rem;
            font-weight: 700;
        }

        .page-info p {
            color: var(--text-muted);
        }

        .user-pill {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-side);
            padding: 6px 16px 6px 6px;
            border-radius: 50px;
            border: 1px solid var(--border);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .user-data {
            display: flex;
            flex-direction: column;
        }

        .user-data strong {
            font-size: 0.9rem;
        }

        .user-data span {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ===== VIEWS ===== */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Dashboard cards */
        .hero-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 3rem;
            border-radius: 24px;
            margin-bottom: 2rem;
        }

        .hero-card h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .hero-card span {
            color: var(--accent);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: var(--bg-side);
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.lab { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .stat-icon.mon { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }

        .arrow {
            margin-left: auto;
            font-size: 1.5rem;
            opacity: 0.3;
        }

        /* Reservas */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .segmented-control {
            background: var(--bg-side);
            padding: 5px;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: inline-flex;
            gap: 5px;
        }

        .seg-btn {
            border: none;
            background: transparent;
            padding: 0.5rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-muted);
            font-weight: 600;
            transition: var(--transition);
        }

        .seg-btn:hover {
            background: var(--bg-main);
            color: var(--text-main);
        }

        .seg-btn.active {
            background: var(--primary);
            color: white;
        }

        .booking-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 2.5rem;
            margin-top: 1rem;
        }

        .cal-widget {
            background: var(--bg-side);
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid var(--border);
            align-self: start;
        }

        .cal-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .cal-nav button {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-main);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            transition: var(--transition);
        }

        .cal-nav button:hover {
            background: var(--bg-main);
        }

        .cal-grid-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            opacity: 0.4;
            font-size: 0.75rem;
            font-weight: 800;
        }

        .cal-days-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .day:not(.empty):hover {
            background: var(--bg-main);
            color: var(--accent);
        }

        .day.active {
            background: var(--accent);
            color: #000;
            font-weight: 700;
            box-shadow: 0 5px 15px var(--accent-glow);
        }

        .schedule-list {
            background: var(--bg-side);
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .list-header {
            padding: 1.2rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .clean-table {
            width: 100%;
            border-collapse: collapse;
        }

        .clean-table th {
            text-align: left;
            padding: 1.2rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            background: rgba(0,0,0,0.02);
        }

        .clean-table td {
            padding: 1rem 1.2rem;
            border-bottom: 1px solid var(--border);
        }

        .clean-table input {
            width: 100%;
            border: 1px solid transparent;
            background: transparent;
            padding: 0.5rem;
            color: inherit;
            border-radius: 8px;
            transition: var(--transition);
        }

        .clean-table input:focus {
            background: var(--bg-main);
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge.booked {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .badge.free {
            background: rgba(100, 116, 139, 0.1);
            color: var(--text-muted);
        }

        .interval-cell {
            text-align: center;
            opacity: 0.6;
            font-size: 0.8rem;
            background: rgba(0,0,0,0.02);
        }

        /* Monitoria */
        .elevated {
            box-shadow: var(--shadow-sm);
        }

        /* Responsividade */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
            }
            .sidebar span:not(.logo-sm),
            .sidebar-brand span {
                display: none;
            }
            .main-content {
                margin-left: 80px;
                padding: 1.5rem;
            }
            .booking-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .main-content {
                padding: 1rem;
            }
            .hero-card {
                padding: 2rem;
            }
            .action-bar {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }
    </style>
</head>
<body class="light-theme">
    <div id="toast-container"></div>

    <!-- TELA DE AUTENTICAÇÃO -->
    <section id="auth-screen" aria-labelledby="auth-title">
        <div class="glass-card">
            <div class="auth-header">
                <div class="logo-box" aria-label="Logo Miguel Gurgel">MG</div>
                <h2 id="auth-title">Bem-vindo de volta</h2>
                <p>Acesse o portal de gestão Miguel Gurgel</p>
            </div>

            <form id="login-form">
                <div class="input-field">
                    <i class="bi bi-envelope" aria-hidden="true"></i>
                    <input type="text" id="login-email" placeholder="E-mail ou Matrícula" required aria-label="E-mail ou matrícula">
                </div>
                <div class="input-field">
                    <i class="bi bi-lock" aria-hidden="true"></i>
                    <input type="password" id="login-pass" placeholder="Sua senha" required aria-label="Senha">
                    <button type="button" class="eye-btn" aria-label="Mostrar senha"><i class="bi bi-eye"></i></button>
                </div>
                <button type="submit" class="btn-primary-glow">Entrar na Plataforma</button>
                <p class="auth-footer">Não tem conta? <a href="#" id="show-signup">Solicitar acesso</a></p>
            </form>

            <form id="signup-form" style="display: none;">
                <div class="input-field">
                    <i class="bi bi-person" aria-hidden="true"></i>
                    <input type="text" id="reg-nome" placeholder="Nome Completo" required>
                </div>
                <div class="input-field">
                    <i class="bi bi-briefcase" aria-hidden="true"></i>
                    <select id="reg-cargo" required>
                        <option value="">Selecione</option>
                        <option value="Professor">Professor(a)</option>
                        <option value="Coordenador">Coordenador(a)</option>
                    </select>
                </div>
                <div class="input-field">
                    <i class="bi bi-envelope-at" aria-hidden="true"></i>
                    <input type="email" id="reg-email" placeholder="E-mail Institucional" required>
                </div>
                <div class="input-field">
                    <i class="bi bi-shield-lock" aria-hidden="true"></i>
                    <input type="password" id="reg-pass" placeholder="Senha (mín. 6 dígitos)" required minlength="6">
                    <button type="button" class="eye-btn" aria-label="Mostrar senha"><i class="bi bi-eye"></i></button>
                </div>
                <button type="submit" class="btn-primary-glow">Criar minha conta</button>
                <p class="auth-footer">Já é cadastrado? <a href="#" id="show-login">Fazer Login</a></p>
            </form>
        </div>
    </section>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="logo-sm">MG</div>
                <span>SGE</span>
            </div>
            <nav class="nav-menu">
                <button class="nav-link active" data-view="menu"><i class="bi bi-grid-1x2-fill"></i> <span>Dashboard</span></button>
                <button class="nav-link" data-view="reservas"><i class="bi bi-calendar-event"></i> <span>Laboratórios</span></button>
                <button class="nav-link" data-view="monitoria"><i class="bi bi-clipboard-check"></i> <span>Monitoria</span></button>
            </nav>
            <div class="sidebar-footer">
                <button class="btn-icon" id="theme-toggle" aria-label="Alternar tema"><i class="bi bi-moon-stars" id="theme-icon"></i></button>
                <button class="btn-icon" id="logout-btn" aria-label="Sair"><i class="bi bi-box-arrow-right"></i></button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div class="page-info">
                    <h1 id="page-title">Dashboard</h1>
                    <p id="page-subtitle">Visão geral do sistema</p>
                </div>
                <div class="user-pill">
                    <div class="user-avatar" id="user-initials">AD</div>
                    <div class="user-data">
                        <strong id="display-user-name">Usuário</strong>
                        <span id="display-user-cargo">Professor</span>
                    </div>
                </div>
            </header>

            <!-- VIEW MENU (DASHBOARD) -->
            <div id="view-menu" class="view active">
                <div class="hero-card">
                    <h2>Bem-vindo ao Novo SGE, <span id="user-greeting">Servidor</span>!</h2>
                    <p>Otimize seu tempo com nossa nova interface de agendamentos.</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card" data-view="reservas">
                        <div class="stat-icon lab"><i class="bi bi-pc-display"></i></div>
                        <div class="stat-text"><h3>Labs</h3><p>Reservar horários</p></div>
                        <i class="bi bi-arrow-right-short arrow"></i>
                    </div>
                    <div class="stat-card" data-view="monitoria">
                        <div class="stat-icon mon"><i class="bi bi-people"></i></div>
                        <div class="stat-text"><h3>Monitoria</h3><p>Escala diária</p></div>
                        <i class="bi bi-arrow-right-short arrow"></i>
                    </div>
                </div>
            </div>

            <!-- VIEW RESERVAS (LABORATÓRIOS) -->
            <div id="view-reservas" class="view">
                <div class="action-bar">
                    <div class="segmented-control">
                        <button class="seg-btn active" data-lab="Informática">Informática</button>
                        <button class="seg-btn" data-lab="Hardware">Hardware</button>
                        <button class="seg-btn" data-lab="Multimídia">Multimídia</button>
                    </div>
                    <button class="btn-outline" id="clear-day-btn"><i class="bi bi-trash3"></i> Limpar Dia</button>
                </div>

                <div class="booking-container">
                    <aside class="cal-widget">
                        <div class="cal-nav">
                            <button id="prev-month" aria-label="Mês anterior"><i class="bi bi-chevron-left"></i></button>
                            <h4 id="cal-month-year">Janeiro 2026</h4>
                            <button id="next-month" aria-label="Próximo mês"><i class="bi bi-chevron-right"></i></button>
                        </div>
                        <div class="cal-grid-header">
                            <span>D</span><span>S</span><span>T</span><span>Q</span><span>Q</span><span>S</span><span>S</span>
                        </div>
                        <div id="cal-days" class="cal-days-body"></div>
                    </aside>

                    <section class="schedule-list">
                        <div class="list-header">
                            <i class="bi bi-calendar3"></i> <span id="current-date-label">Selecione uma data</span>
                        </div>
                        <div class="table-wrapper">
                            <table class="clean-table">
                                <thead>
                                    <tr><th>Horário</th><th>Professor / Atividade</th><th>Turma</th><th>Status</th></tr>
                                </thead>
                                <tbody id="reserva-rows"></tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>

            <!-- VIEW MONITORIA -->
            <div id="view-monitoria" class="view">
                <div class="table-wrapper elevated">
                    <table class="clean-table">
                        <thead>
                            <tr><th>Posto de Apoio</th><th>Aluno Monitor</th><th>Turma</th><th>Ação</th></tr>
                        </thead>
                        <tbody id="monitoria-rows">
                            <!-- Dados mockados serão inseridos via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        (function() {
            // ========== TOAST SYSTEM ==========
            function showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.setAttribute('role', 'alert');
                const icon = {
                    success: 'bi-check-circle-fill',
                    error: 'bi-exclamation-triangle-fill',
                    warning: 'bi-exclamation-circle-fill',
                    info: 'bi-info-circle-fill'
                }[type] || 'bi-info-circle-fill';
                toast.innerHTML = `<i class="bi ${icon}"></i><span>${message}</span>`;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }

            // ========== STORAGE (com prefixo) ==========
            const STORAGE_PREFIX = 'mg_sge_';
            function storageSave(key, value) {
                try {
                    localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error('Erro ao salvar', e);
                    return false;
                }
            }
            function storageGet(key) {
                try {
                    const item = localStorage.getItem(STORAGE_PREFIX + key);
                    return item ? JSON.parse(item) : null;
                } catch (e) {
                    return null;
                }
            }
            function storageRemove(key) {
                localStorage.removeItem(STORAGE_PREFIX + key);
            }

            // ========== ESTADO GLOBAL ==========
            let state = {
                user: null,
                currentLab: 'Informática',
                selectedDate: new Date(),
                calendarDate: new Date(),
                config: {
                    slots: ["07:20 - 08:10", "08:10 - 09:00", "09:20 - 10:10", "10:10 - 11:00", "11:00 - 11:50", "12:00 - 13:00 (Intervalo)", "13:10 - 14:00", "14:00 - 14:50", "15:10 - 16:00", "16:00 - 16:50"],
                    postos: ["Fila do Intervalo", "Refeitório (Suco)", "Refeitório (Pratos)", "Portaria Almoço", "Pátio Central"]
                }
            };

            // ========== FUNÇÕES AUXILIARES ==========
            function formatDateKey(date) {
                return date.toISOString().split('T')[0];
            }
            function formatDateLong(date) {
                return date.toLocaleDateString('pt-BR', { dateStyle: 'long' });
            }

            // ========== CALENDÁRIO ==========
            function renderCalendar() {
                const container = document.getElementById('cal-days');
                const display = document.getElementById('cal-month-year');
                if (!container) return;

                const year = state.calendarDate.getFullYear();
                const month = state.calendarDate.getMonth();
                display.innerText = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' }).format(state.calendarDate);

                const firstDay = new Date(year, month, 1).getDay(); // 0 = domingo
                const lastDay = new Date(year, month + 1, 0).getDate();

                let html = '';
                for (let i = 0; i < firstDay; i++) {
                    html += '<div class="day empty"></div>';
                }
                for (let d = 1; d <= lastDay; d++) {
                    const dateObj = new Date(year, month, d);
                    const isSelected = formatDateKey(dateObj) === formatDateKey(state.selectedDate);
                    html += `<div class="day ${isSelected ? 'active' : ''}" data-date="${dateObj.toISOString()}">${d}</div>`;
                }
                container.innerHTML = html;

                // Eventos de clique nos dias
                container.querySelectorAll('.day:not(.empty)').forEach(day => {
                    day.addEventListener('click', () => {
                        const dateStr = day.dataset.date;
                        state.selectedDate = new Date(dateStr);
                        renderCalendar();
                        renderSchedule();
                    });
                });
            }

            function changeMonth(direction) {
                state.calendarDate.setMonth(state.calendarDate.getMonth() + direction);
                renderCalendar();
            }

            // ========== RESERVAS ==========
            function renderSchedule() {
                const tbody = document.getElementById('reserva-rows');
                if (!tbody) return;
                const dateKey = formatDateKey(state.selectedDate);
                document.getElementById('current-date-label').innerText = formatDateLong(state.selectedDate);

                tbody.innerHTML = '';
                state.config.slots.forEach((slot, index) => {
                    const key = `res_${state.currentLab}_${dateKey}_${index}`;
                    const saved = storageGet(key) || { prof: '', turma: '' };
                    const isInterval = slot.includes('Intervalo');

                    const tr = document.createElement('tr');
                    if (isInterval) {
                        tr.innerHTML = `<td colspan="4" class="interval-cell">☕ ${slot}</td>`;
                    } else {
                        tr.innerHTML = `
                            <td><strong>${slot}</strong></td>
                            <td><input type="text" class="reserva-prof" data-index="${index}" value="${saved.prof.replace(/"/g, '&quot;')}" placeholder="Professor(a)"></td>
                            <td><input type="text" class="reserva-turma" data-index="${index}" value="${saved.turma.replace(/"/g, '&quot;')}" placeholder="Turma"></td>
                            <td><span class="badge ${saved.prof ? 'booked' : 'free'}">${saved.prof ? 'Reservado' : 'Disponível'}</span></td>
                        `;
                    }
                    tbody.appendChild(tr);
                });

                // Eventos nos inputs
                tbody.querySelectorAll('.reserva-prof, .reserva-turma').forEach(input => {
                    input.addEventListener('change', function() {
                        const index = this.dataset.index;
                        const field = this.classList.contains('reserva-prof') ? 'prof' : 'turma';
                        const value = this.value;
                        const dateKey = formatDateKey(state.selectedDate);
                        const key = `res_${state.currentLab}_${dateKey}_${index}`;
                        let data = storageGet(key) || { prof: '', turma: '' };
                        data[field] = field === 'turma' ? value.toUpperCase() : value;
                        storageSave(key, data);
                        renderSchedule(); // atualiza badge
                        showToast('Reserva atualizada', 'success');
                    });
                });
            }

            function clearDay() {
                if (!confirm('Tem certeza que deseja limpar todas as reservas deste dia?')) return;
                const dateKey = formatDateKey(state.selectedDate);
                state.config.slots.forEach((_, index) => {
                    const key = `res_${state.currentLab}_${dateKey}_${index}`;
                    storageRemove(key);
                });
                renderSchedule();
                showToast('Reservas do dia removidas', 'info');
            }

            // ========== MONITORIA (dados mockados) ==========
            function renderMonitoria() {
                const tbody = document.getElementById('monitoria-rows');
                if (!tbody) return;
                const mockData = [
                    { posto: 'Fila do Intervalo', monitor: 'Ana Beatriz', turma: '3º A' },
                    { posto: 'Refeitório (Suco)', monitor: 'Carlos Eduardo', turma: '2º B' },
                    { posto: 'Refeitório (Pratos)', monitor: 'Fernanda Lima', turma: '3º C' },
                    { posto: 'Portaria Almoço', monitor: 'João Pedro', turma: '1º A' },
                    { posto: 'Pátio Central', monitor: 'Mariana Souza', turma: '2º A' },
                ];
                tbody.innerHTML = mockData.map(item => `
                    <tr>
                        <td>${item.posto}</td>
                        <td>${item.monitor}</td>
                        <td>${item.turma}</td>
                        <td><button class="btn-outline" style="padding:0.3rem 1rem;">Editar</button></td>
                    </tr>
                `).join('');
            }

            // ========== AUTENTICAÇÃO ==========
            function handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value.trim().toLowerCase();
                const password = document.getElementById('login-pass').value;
                if (!email || !password) {
                    showToast('Preencha todos os campos', 'error');
                    return;
                }
                const user = storageGet(`user_${email}`);
                // Simples validação: em produção, use hash!
                if (user && user.password === password) {
                    state.user = user;
                    storageSave('current_session', user.email);
                    showToast('Login realizado!', 'success');
                    initDashboard();
                } else {
                    showToast('E-mail ou senha inválidos', 'error');
                }
            }

            function handleSignup(e) {
                e.preventDefault();
                const nome = document.getElementById('reg-nome').value.trim();
                const cargo = document.getElementById('reg-cargo').value;
                const email = document.getElementById('reg-email').value.trim().toLowerCase();
                const password = document.getElementById('reg-pass').value;

                if (!nome || !cargo || !email || !password) {
                    showToast('Preencha todos os campos', 'error');
                    return;
                }
                if (password.length < 6) {
                    showToast('A senha deve ter no mínimo 6 caracteres', 'error');
                    return;
                }
                if (storageGet(`user_${email}`)) {
                    showToast('Este e-mail já está cadastrado', 'error');
                    return;
                }
                const user = { nome, cargo, email, password };
                storageSave(`user_${email}`, user);
                showToast('Conta criada! Faça login.', 'success');
                toggleAuthForm('login');
            }

            function toggleAuthForm(form) {
                document.getElementById('login-form').style.display = form === 'login' ? 'block' : 'none';
                document.getElementById('signup-form').style.display = form === 'signup' ? 'block' : 'none';
            }

            function checkSession() {
                const sessionEmail = storageGet('current_session');
                if (sessionEmail) {
                    const user = storageGet(`user_${sessionEmail}`);
                    if (user) {
                        state.user = user;
                        initDashboard();
                    }
                }
            }

            function logout() {
                state.user = null;
                storageRemove('current_session');
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
                // Reset forms
                document.getElementById('login-form').reset();
                document.getElementById('signup-form').reset();
                toggleAuthForm('login');
                showToast('Até logo!', 'info');
            }

            function initDashboard() {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                const u = state.user;
                document.getElementById('display-user-name').innerText = u.nome;
                document.getElementById('display-user-cargo').innerText = u.cargo;
                document.getElementById('user-greeting').innerText = u.nome.split(' ')[0];
                const initials = u.nome.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
                document.getElementById('user-initials').innerText = initials;

                // Inicializa views
                renderCalendar();
                renderSchedule();
                renderMonitoria();
            }

            // ========== NAVEGAÇÃO ==========
            function navigateTo(viewId) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(`view-${viewId}`).classList.add('active');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector(`.nav-link[data-view="${viewId}"]`).classList.add('active');
                const titles = { menu: 'Dashboard', reservas: 'Laboratórios', monitoria: 'Monitoria' };
                document.getElementById('page-title').innerText = titles[viewId];
                if (viewId === 'monitoria') renderMonitoria();
            }

            // ========== TEMA ==========
            function toggleTheme() {
                document.body.classList.toggle('dark-theme');
                const icon = document.getElementById('theme-icon');
                icon.className = document.body.classList.contains('dark-theme') ? 'bi bi-sun' : 'bi bi-moon-stars';
                storageSave('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
            }

            function loadTheme() {
                const savedTheme = storageGet('theme') || 'light';
                document.body.className = savedTheme === 'dark' ? 'dark-theme' : 'light-theme';
                document.getElementById('theme-icon').className = savedTheme === 'dark' ? 'bi bi-sun' : 'bi bi-moon-stars';
            }

            // ========== INICIALIZAÇÃO DE EVENTOS ==========
            document.addEventListener('DOMContentLoaded', function() {
                loadTheme();
                checkSession();

                // Login / Signup
                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.getElementById('signup-form').addEventListener('submit', handleSignup);
                document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); toggleAuthForm('signup'); });
                document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); toggleAuthForm('login'); });

                // Mostrar senha
                document.querySelectorAll('.eye-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const input = this.closest('.input-field').querySelector('input[type="password"], input[type="text"]');
                        if (input) {
                            const type = input.type === 'password' ? 'text' : 'password';
                            input.type = type;
                            this.querySelector('i').className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
                        }
                    });
                });

                // Navegação
                document.querySelectorAll('[data-view]').forEach(el => {
                    el.addEventListener('click', () => navigateTo(el.dataset.view));
                });

                // Logout
                document.getElementById('logout-btn').addEventListener('click', logout);

                // Tema
                document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

                // Calendário
                document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
                document.getElementById('next-month').addEventListener('click', () => changeMonth(1));

                // Laboratórios
                document.querySelectorAll('.seg-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const lab = this.dataset.lab;
                        if (lab) {
                            state.currentLab = lab;
                            document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            renderSchedule();
                        }
                    });
                });

                document.getElementById('clear-day-btn').addEventListener('click', clearDay);

                // Se já estiver logado, o dashboard será mostrado via checkSession
                // Se não, exibe auth normalmente
            });
        })();
    </script>
</body>
</html>