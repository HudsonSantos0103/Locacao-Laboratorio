<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EEEP Comendador Miguel Gurgel | Sistema de Gest√£o Escolar</title>
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <style>
        /* ===== VARI√ÅVEIS E RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        :root {
            --bg-light: #f8fafc;
            --bg-dark: #0b1120;
            --card-light: rgba(255, 255, 255, 0.8);
            --card-dark: rgba(15, 23, 42, 0.9);
            --primary: #0f172a;      /* Azul escuro */
            --primary-light: #1e293b;
            --accent: #f59e0b;        /* Dourado */
            --accent-hover: #d97706;
            --border-light: #e2e8f0;
            --border-dark: #334155;
            --text-light: #1e293b;
            --text-dark: #f1f5f9;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 20px 30px -10px rgba(0, 0, 0, 0.2);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--bg-light);
            color: var(--text-light);
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark {
            --bg-light: var(--bg-dark);
            --card-light: var(--card-dark);
            --border-light: var(--border-dark);
            --text-light: var(--text-dark);
        }

        /* ===== COMPONENTES GLOBAIS ===== */
        #toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: var(--primary);
            color: white;
            padding: 14px 20px;
            border-radius: 12px;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            max-width: 380px;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            border-left: 5px solid var(--accent);
            backdrop-filter: blur(4px);
        }

        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--error); }
        .toast.warning { border-left-color: var(--warning); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(20px); }
        }

        /* ===== TELA DE AUTENTICA√á√ÉO ===== */
        #auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: radial-gradient(circle at 10% 30%, var(--accent) 0%, transparent 30%),
                        linear-gradient(135deg, var(--bg-light) 0%, #e2e8f0 100%);
            padding: 16px;
        }

        .auth-container {
            background: var(--card-light);
            backdrop-filter: blur(12px);
            padding: 40px;
            border-radius: 32px;
            width: 100%;
            max-width: 440px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
        }

        .school-logo-img {
            max-width: 100%;
            height: auto;
            margin-bottom: 20px;
        }

        .school-logo-text {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 24px;
            text-decoration: none;
            border-bottom: none;
        }

        .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid transparent;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.7);
            font-size: 15px;
            transition: var(--transition);
            outline: none;
        }

        .input-group input:focus, .input-group select:focus {
            border-color: var(--accent);
            background: white;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
        }

        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--primary);
            font-size: 18px;
        }

        .password-strength {
            height: 4px;
            background: #e2e8f0;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .strength-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        .strength-weak { background: var(--error); width: 33%; }
        .strength-medium { background: var(--warning); width: 66%; }
        .strength-strong { background: var(--success); width: 100%; }

        /* Bot√µes de autentica√ß√£o */
        .btn-auth {
            width: 100%;
            padding: 14px;
            border-radius: 40px;
            background: var(--primary);
            color: white;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-auth:hover {
            background: var(--primary-light);
            transform: scale(1.02);
        }

        .auth-link {
            text-align: center;
            margin-top: 20px;
        }

        .auth-link a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-link a:hover {
            text-decoration: underline;
        }

        /* ===== CABE√áALHO DO SISTEMA ===== */
        #sys-header {
            background: var(--primary);
            color: white;
            padding: 12px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
            background: rgba(15, 23, 42, 0.95);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-brasao {
            height: 48px;
            width: auto;
            filter: brightness(0) invert(1); /* torna a imagem branca se for escura */
        }

        .header-brand {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
            line-height: 1.2;
        }

        .header-brand small {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.8;
            display: block;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .dark-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .dark-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 40px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* ===== CONTE√öDO PRINCIPAL ===== */
        #app-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .section {
            display: none;
            animation: fadeIn 0.4s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== CARDS DO MENU ===== */
        .welcome-box {
            text-align: center;
            margin: 40px 0 20px;
        }

        .welcome-box h1 {
            font-size: 36px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none;
            border-bottom: none;
        }

        .menu-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            padding: 20px 0 60px;
        }

        .card {
            background: var(--card-light);
            backdrop-filter: blur(10px);
            padding: 40px 24px;
            border-radius: 32px;
            cursor: pointer;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent);
        }

        .card-icon {
            font-size: 64px;
            margin-bottom: 20px;
            filter: drop-shadow(0 8px 12px rgba(0,0,0,0.1));
        }

        /* ===== M√ìDULOS ===== */
        .module-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }

        .lab-selector {
            display: flex;
            gap: 8px;
            background: rgba(0,0,0,0.05);
            padding: 6px;
            border-radius: 40px;
        }

        .btn-lab {
            border: none;
            padding: 10px 20px;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 600;
            background: transparent;
            color: var(--text-light);
            transition: var(--transition);
        }

        .btn-lab.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4);
        }

        .filter-bar {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .filter-bar select, .filter-bar button {
            padding: 12px 20px;
            border-radius: 40px;
            border: 1px solid var(--border-light);
            background: var(--card-light);
            backdrop-filter: blur(4px);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-bar button {
            background: var(--primary);
            color: white;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .filter-bar button:hover {
            background: var(--primary-light);
            transform: scale(1.02);
        }

        .btn-back {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-back:hover {
            background: var(--primary-light);
            transform: translateX(-4px);
        }

        /* ===== TABELAS ===== */
        .table-container {
            background: var(--card-light);
            backdrop-filter: blur(8px);
            border-radius: 24px;
            border: 1px solid var(--border-light);
            overflow-x: auto;
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }

        th {
            background: rgba(0,0,0,0.02);
            padding: 18px 16px;
            text-align: left;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--primary);
            border-bottom: 2px solid var(--accent);
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
        }

        td input, td select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid transparent;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.6);
            transition: var(--transition);
            font-size: 14px;
        }

        td input:focus {
            border-color: var(--accent);
            background: white;
            outline: none;
        }

        .lunch-break {
            background: rgba(245, 158, 11, 0.1);
            text-align: center;
            font-weight: 600;
            color: var(--accent);
            font-size: 14px;
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            transition: var(--transition);
            color: var(--primary);
        }

        .btn-icon:hover {
            background: var(--accent);
            color: white;
            transform: scale(1.1);
        }

        .btn-save-all {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            transition: var(--transition);
        }

        .btn-save-all:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        /* ===== DARK MODE AJUSTES ===== */
        body.dark .card,
        body.dark .auth-container,
        body.dark .table-container,
        body.dark .filter-bar select {
            background: rgba(15, 23, 42, 0.8);
            border-color: #334155;
        }

        body.dark td input {
            background: #1e293b;
            color: white;
            border-color: #334155;
        }

        body.dark td input:focus {
            border-color: var(--accent);
            background: #0f172a;
        }

        body.dark .header-brasao {
            filter: none; /* mant√©m a original no dark mode se ela for clara */
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .module-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-brand {
                font-size: 16px;
            }
            .header-brasao {
                height: 36px;
            }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <!-- TELA DE AUTENTICA√á√ÉO -->
    <div id="auth-screen">
        <div class="auth-container">
            <div id="login-form">
                <!-- Logo horizontal da escola -->
                <img src="imagens/logo-horizontal.png" alt="EEEP Comendador Miguel Gurgel" class="school-logo-img" onerror="this.style.display='none'">
                <div class="school-logo-text" style="display: none;">EEEP Comendador Miguel Gurgel</div>
                <h2 style="margin-bottom:24px;">Acesso ao Sistema</h2>
                <div class="input-group">
                    <input type="text" id="login-email" placeholder="E-mail ou Matr√≠cula">
                </div>
                <div class="input-group">
                    <input type="password" id="login-pass" placeholder="Senha">
                    <span class="password-toggle" onclick="togglePassword('login-pass')">üëÅÔ∏è</span>
                </div>
                <button class="btn-auth" onclick="handleLogin()">Entrar</button>
                <p class="auth-link">Novo por aqui? <a href="#" onclick="toggleAuth('signup')">Criar conta</a></p>
            </div>

            <div id="signup-form" style="display: none;">
                <img src="imagens/logo-horizontal.png" alt="EEEP Comendador Miguel Gurgel" class="school-logo-img" onerror="this.style.display='none'">
                <div class="school-logo-text" style="display: none;">Cadastro</div>
                <div class="input-group">
                    <input type="text" id="reg-nome" placeholder="Nome Completo">
                </div>
                <div class="input-group">
                    <select id="reg-cargo">
                        <option value="Professor">Professor(a)</option>
                        <option value="Coordenador">Coordenador(a)</option>
                    </select>
                </div>
                <div class="input-group">
                    <input type="email" id="reg-email" placeholder="E-mail Institucional">
                </div>
                <div class="input-group">
                    <input type="password" id="reg-pass" placeholder="Senha (m√≠n. 6 d√≠gitos)" oninput="checkPasswordStrength(this.value)">
                    <span class="password-toggle" onclick="togglePassword('reg-pass')">üëÅÔ∏è</span>
                </div>
                <div class="password-strength">
                    <div id="strength-bar" class="strength-bar"></div>
                </div>
                <button class="btn-auth" onclick="handleSignup()" style="margin-top:16px;">Finalizar Cadastro</button>
                <p class="auth-link">J√° tem conta? <a href="#" onclick="toggleAuth('login')">Fazer Login</a></p>
            </div>
        </div>
    </div>

    <!-- CABE√áALHO DO SISTEMA -->
    <header id="sys-header" style="display: none;">
        <div class="header-left">
            <!-- Bras√£o da escola -->
            <img src="imagens/brasao.png" alt="Bras√£o" class="header-brasao" onerror="this.style.display='none'">
            <div class="header-brand">
                EEEP Comendador Miguel Gurgel
                <small>Sistema de Gest√£o Escolar</small>
            </div>
        </div>
        <div class="header-actions">
            <button class="dark-toggle" onclick="toggleDarkMode()" id="darkModeBtn">üåô</button>
            <div class="user-info">
                <span id="user-info"></span>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
        </div>
    </header>

    <!-- CONTE√öDO PRINCIPAL -->
    <main id="app-content" style="display: none;">
        <!-- MENU PRINCIPAL -->
        <div id="main-menu" class="section active">
            <div class="welcome-box">
                <h1>Bem-vindo, servidor!</h1>
                <p style="opacity:0.7;">O que voc√™ deseja gerenciar hoje?</p>
            </div>
            <div class="menu-cards">
                <div class="card" onclick="showSection('reservas')">
                    <div class="card-icon">üè´</div>
                    <h3>Aloca√ß√£o de Laborat√≥rios</h3>
                    <p>Controle de hor√°rios de Inform√°tica, Hardware e Multim√≠dia.</p>
                </div>
                <div class="card" onclick="showSection('monitoria')">
                    <div class="card-icon">üìã</div>
                    <h3>Escala de Monitoria</h3>
                    <p>Gest√£o de postos de apoio e alunos monitores.</p>
                </div>
            </div>
        </div>

        <!-- M√ìDULO RESERVAS -->
        <section id="sec-reservas" class="section">
            <div class="module-header">
                <button class="btn-back" onclick="showSection('menu')">‚Üê Voltar ao Menu</button>
                <div class="lab-selector">
                    <button class="btn-lab active" onclick="changeLab('Lab Inform√°tica', this)">üíª Inform√°tica</button>
                    <button class="btn-lab" onclick="changeLab('Lab Hardware', this)">üõ†Ô∏è Hardware</button>
                    <button class="btn-lab" onclick="changeLab('Lab Multim√≠dia', this)">üé¨ Multim√≠dia</button>
                </div>
            </div>

            <div class="filter-bar">
                <select id="semanaSelect" onchange="renderTable()">
                    <option value="1">Semana 1</option><option value="2">Semana 2</option>
                    <option value="3">Semana 3</option><option value="4">Semana 4</option>
                </select>
                <select id="diaSelect" onchange="renderTable()">
                    <option value="Segunda">Segunda-feira</option><option value="Ter√ßa">Ter√ßa-feira</option>
                    <option value="Quarta">Quarta-feira</option><option value="Quinta">Quinta-feira</option>
                    <option value="Sexta">Sexta-feira</option>
                </select>
                <button onclick="copyPreviousWeek()">üìã Copiar da semana anterior</button>
                <button onclick="clearDay()">üßπ Limpar dia</button>
            </div>

            <h2 id="currentLabTitle">Lab Inform√°tica</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 150px;">Hor√°rio</th>
                            <th>Professor Respons√°vel</th>
                            <th style="width: 180px;">Turma</th>
                            <th style="width: 120px;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <button class="btn-save-all" onclick="saveAllReservations()">üíæ Salvar todas as altera√ß√µes</button>
        </section>

        <!-- M√ìDULO MONITORIA -->
        <section id="sec-monitoria" class="section">
            <div class="module-header">
                <button class="btn-back" onclick="showSection('menu')">‚Üê Voltar ao Menu</button>
                <h2>Escala de Monitoria</h2>
                <button class="btn-primary" onclick="addMonitoriaPosto()" style="width:auto; padding:10px 24px;">‚ûï Novo Posto</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 250px;">Posto / Fun√ß√£o</th>
                            <th>Nome do Aluno Monitor</th>
                            <th style="width: 180px;">Turma</th>
                            <th style="width: 120px;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tableBodyMonitoria"></tbody>
                </table>
            </div>
            <button class="btn-save-all" onclick="saveAllMonitoria()">üíæ Salvar todas as altera√ß√µes</button>
        </section>
    </main>

    <script>
        // (O JavaScript permanece o mesmo, pois n√£o havia necessidade de altera√ß√£o)
        // ==================== CONFIGURA√á√ïES E ESTADO GLOBAL ====================
        const CONFIG = {
            slots: ["07:20 - 08:10", "08:10 - 09:00", "09:20 - 10:10", "10:10 - 11:00", "11:00 - 11:50", "12:00 - 13:00", "13:10 - 14:00", "14:00 - 14:50", "15:10 - 16:00", "16:00 - 16:50"],
            turmasValidas: ["DS1", "DS2", "DS3", "MULTI1", "MULTI2", "MULTI3", "CTB1", "CTB2", "CTB3", "RDC1", "RDC2", "RDC3"],
            labs: ["Lab Inform√°tica", "Lab Hardware", "Lab Multim√≠dia"],
            diasSemana: ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta"],
            semanas: [1, 2, 3, 4]
        };

        let currentLab = "Lab Inform√°tica";
        let currentUser = null;
        let darkMode = localStorage.getItem('darkMode') === 'true';

        // Estrutura de dados unificada
        let appData = {
            version: '2.0',
            users: {},
            reservations: {}, // chave: `${lab}-S${semana}-${dia}-${slot}`
            monitoria: [] // array de { posto, aluno, turma, id }
        };

        // ==================== FUN√á√ïES DE DADOS ====================
        function loadData() {
            const stored = localStorage.getItem('sge_data');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (parsed.version === '2.0') {
                        appData = parsed;
                    } else {
                        migrateOldData();
                    }
                } catch { migrateOldData(); }
            } else {
                migrateOldData();
            }
            // Garantir que monitoria n√£o esteja vazia (apenas se realmente vazia)
            if (!appData.monitoria || appData.monitoria.length === 0) {
                appData.monitoria = [
                    { id: '1', posto: 'Fila do Intervalo', aluno: '', turma: '' },
                    { id: '2', posto: 'Refeit√≥rio (Suco)', aluno: '', turma: '' },
                    { id: '3', posto: 'Refeit√≥rio (Pratos)', aluno: '', turma: '' },
                    { id: '4', posto: 'Portaria Almo√ßo', aluno: '', turma: '' },
                    { id: '5', posto: 'P√°tio Central', aluno: '', turma: '' },
                    { id: '6', posto: 'Fila Almo√ßo', aluno: '', turma: '' }
                ];
            }
            saveData();
        }

        function migrateOldData() {
            // Converte dados do formato antigo (chaves individuais) para o novo
            const oldReservations = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('res-')) {
                    try {
                        oldReservations[key] = JSON.parse(localStorage.getItem(key));
                    } catch {
                        oldReservations[key] = { prof: '', turma: '' };
                    }
                } else if (key.startsWith('mon-')) {
                    const posto = key.replace('mon-', '');
                    try {
                        const value = JSON.parse(localStorage.getItem(key));
                        appData.monitoria.push({
                            id: Date.now() + Math.random(),
                            posto: posto,
                            aluno: value.aluno || '',
                            turma: value.turma || ''
                        });
                    } catch { }
                }
            }
            appData.reservations = oldReservations;
            saveData();
        }

        function saveData() {
            localStorage.setItem('sge_data', JSON.stringify(appData));
        }

        // ==================== TOAST ====================
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            toast.innerHTML = `${icon} ${msg}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ==================== AUTENTICA√á√ÉO ====================
        function toggleAuth(type) {
            document.getElementById('login-form').style.display = type === 'signup' ? 'none' : 'block';
            document.getElementById('signup-form').style.display = type === 'signup' ? 'block' : 'none';
        }

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            field.type = field.type === 'password' ? 'text' : 'password';
        }

        function checkPasswordStrength(pass) {
            const bar = document.getElementById('strength-bar');
            if (pass.length < 6) {
                bar.className = 'strength-bar';
                return;
            }
            let strength = 0;
            if (pass.length >= 8) strength++;
            if (/[A-Z]/.test(pass)) strength++;
            if (/[0-9]/.test(pass)) strength++;
            if (/[^A-Za-z0-9]/.test(pass)) strength++;
            if (strength <= 2) bar.className = 'strength-bar strength-weak';
            else if (strength === 3) bar.className = 'strength-bar strength-medium';
            else bar.className = 'strength-bar strength-strong';
        }

        function handleSignup() {
            const email = document.getElementById('reg-email').value.toLowerCase().trim();
            const nome = document.getElementById('reg-nome').value.trim();
            const pass = document.getElementById('reg-pass').value;
            const cargo = document.getElementById('reg-cargo').value;

            if (!email || !nome || pass.length < 6) {
                showToast('Preencha todos os campos e use senha com no m√≠nimo 6 caracteres', 'error');
                return;
            }
            if (appData.users[email]) {
                showToast('E-mail j√° cadastrado!', 'error');
                return;
            }
            appData.users[email] = { nome, pass, cargo };
            saveData();
            showToast('‚úÖ Cadastro realizado com sucesso!', 'success');
            toggleAuth('login');
        }

        function handleLogin() {
            const email = document.getElementById('login-email').value.toLowerCase().trim();
            const pass = document.getElementById('login-pass').value;
            const user = appData.users[email];

            if (user && user.pass === pass) {
                currentUser = { email, ...user };
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('sys-header').style.display = 'flex';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('user-info').innerText = `${user.cargo}: ${user.nome}`;
                showSection('menu');
                showToast(`Bem-vindo, ${user.nome}!`, 'success');
                // Salva login no localStorage para persist√™ncia (opcional)
                localStorage.setItem('sge_logged_user', email);
            } else {
                showToast('‚ùå E-mail ou senha incorretos.', 'error');
            }
        }

        // Verifica se h√° usu√°rio logado ao iniciar
        (function checkAutoLogin() {
            const savedEmail = localStorage.getItem('sge_logged_user');
            if (savedEmail && appData.users[savedEmail]) {
                document.getElementById('login-email').value = savedEmail;
                // N√£o preenche a senha automaticamente por seguran√ßa
            }
        })();

        // ==================== NAVEGA√á√ÉO ====================
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            if (id === 'menu') {
                document.getElementById('main-menu').classList.add('active');
            } else {
                document.getElementById(`sec-${id}`).classList.add('active');
                if (id === 'reservas') renderTable();
                else if (id === 'monitoria') renderMonitoria();
            }
        }

        // ==================== M√ìDULO RESERVAS ====================
        function changeLab(lab, btn) {
            currentLab = lab;
            document.getElementById('currentLabTitle').innerText = lab;
            document.querySelectorAll('.btn-lab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderTable();
        }

        function getReservationKey(lab, semana, dia, slot) {
            return `${lab}-S${semana}-${dia}-${slot}`;
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const semana = document.getElementById('semanaSelect').value;
            const dia = document.getElementById('diaSelect').value;
            tbody.innerHTML = '';

            CONFIG.slots.forEach((slot, i) => {
                const isLunch = slot.includes('12:00');
                const key = getReservationKey(currentLab, semana, dia, slot);
                const saved = appData.reservations[key] || { prof: '', turma: '' };

                const row = document.createElement('tr');
                if (isLunch) {
                    row.innerHTML = `<td colspan="4" class="lunch-break">üç± INTERVALO DE ALMO√áO</td>`;
                } else {
                    row.setAttribute('data-slot', slot);
                    row.setAttribute('data-index', i);
                    // Escapa aspas simples no valor para n√£o quebrar o onclick
                    const profEscaped = saved.prof.replace(/'/g, "\\'");
                    const turmaEscaped = saved.turma.replace(/'/g, "\\'");
                    row.innerHTML = `
                        <td><strong>${slot}</strong></td>
                        <td><input type="text" class="prof-input" data-slot="${slot}" value="${profEscaped}" placeholder="Nome do Professor"></td>
                        <td><input type="text" class="turma-input" data-slot="${slot}" value="${turmaEscaped}" placeholder="Turma" list="turmas-list"></td>
                        <td>
                            <button class="btn-icon" onclick="clearSlot('${slot.replace(/'/g, "\\'")}')" title="Limpar">üßπ</button>
                            <button class="btn-icon" onclick="saveSlot('${slot.replace(/'/g, "\\'")}')" title="Salvar">üíæ</button>
                        </td>
                    `;
                }
                tbody.appendChild(row);
            });
        }

        function saveSlot(slot) {
            const semana = document.getElementById('semanaSelect').value;
            const dia = document.getElementById('diaSelect').value;
            const profInput = document.querySelector(`.prof-input[data-slot="${slot}"]`);
            const turmaInput = document.querySelector(`.turma-input[data-slot="${slot}"]`);
            if (!profInput || !turmaInput) return;

            const key = getReservationKey(currentLab, semana, dia, slot);
            appData.reservations[key] = {
                prof: profInput.value.trim(),
                turma: turmaInput.value.trim().toUpperCase()
            };
            saveData();
            showToast(`Hor√°rio ${slot} salvo!`, 'success');
        }

        function clearSlot(slot) {
            if (!confirm('Limpar este hor√°rio?')) return;
            const semana = document.getElementById('semanaSelect').value;
            const dia = document.getElementById('diaSelect').value;
            const key = getReservationKey(currentLab, semana, dia, slot);
            delete appData.reservations[key];
            saveData();
            renderTable();
            showToast('Hor√°rio limpo!', 'warning');
        }

        function saveAllReservations() {
            const semana = document.getElementById('semanaSelect').value;
            const dia = document.getElementById('diaSelect').value;
            document.querySelectorAll('#tableBody tr').forEach(row => {
                const slot = row.getAttribute('data-slot');
                if (slot) {
                    const prof = row.querySelector('.prof-input')?.value.trim() || '';
                    const turma = row.querySelector('.turma-input')?.value.trim().toUpperCase() || '';
                    const key = getReservationKey(currentLab, semana, dia, slot);
                    if (prof || turma) {
                        appData.reservations[key] = { prof, turma };
                    } else {
                        delete appData.reservations[key];
                    }
                }
            });
            saveData();
            showToast('Todas as altera√ß√µes foram salvas!', 'success');
        }

        function copyPreviousWeek() {
            const semanaAtual = parseInt(document.getElementById('semanaSelect').value);
            if (semanaAtual === 1) {
                showToast('N√£o h√° semana anterior para copiar.', 'warning');
                return;
            }
            if (!confirm('Copiar todas as reservas da semana anterior para esta semana?')) return;

            const dia = document.getElementById('diaSelect').value;
            const semanaAnterior = semanaAtual - 1;

            CONFIG.slots.forEach(slot => {
                if (slot.includes('12:00')) return;
                const keyOld = getReservationKey(currentLab, semanaAnterior, dia, slot);
                const keyNew = getReservationKey(currentLab, semanaAtual, dia, slot);
                if (appData.reservations[keyOld]) {
                    appData.reservations[keyNew] = { ...appData.reservations[keyOld] };
                }
            });
            saveData();
            renderTable();
            showToast('Semana anterior copiada!', 'success');
        }

        function clearDay() {
            if (!confirm('Limpar todas as reservas deste dia?')) return;
            const semana = document.getElementById('semanaSelect').value;
            const dia = document.getElementById('diaSelect').value;
            CONFIG.slots.forEach(slot => {
                if (slot.includes('12:00')) return;
                const key = getReservationKey(currentLab, semana, dia, slot);
                delete appData.reservations[key];
            });
            saveData();
            renderTable();
            showToast('Dia limpo!', 'warning');
        }

        // ==================== M√ìDULO MONITORIA ====================
        function renderMonitoria() {
            const tbody = document.getElementById('tableBodyMonitoria');
            tbody.innerHTML = '';
            appData.monitoria.forEach((item) => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', item.id);
                row.setAttribute('draggable', 'true');
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                // Escapa aspas simples nos valores
                const postoEscaped = item.posto.replace(/'/g, "\\'");
                const alunoEscaped = item.aluno.replace(/'/g, "\\'");
                const turmaEscaped = item.turma.replace(/'/g, "\\'");
                row.innerHTML = `
                    <td><input type="text" class="posto-input" value="${postoEscaped}" placeholder="Nome do Posto"></td>
                    <td><input type="text" class="aluno-input" value="${alunoEscaped}" placeholder="Nome do Aluno"></td>
                    <td><input type="text" class="turma-mon-input" value="${turmaEscaped}" placeholder="Turma" list="turmas-list"></td>
                    <td>
                        <button class="btn-icon" onclick="deleteMonitoriaPosto('${item.id}')" title="Excluir">üóëÔ∏è</button>
                        <button class="btn-icon" onclick="saveMonitoriaPosto('${item.id}')" title="Salvar">üíæ</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        let draggedRow = null;
        function handleDragStart(e) {
            draggedRow = this;
            e.dataTransfer.setData('text/plain', this.getAttribute('data-id'));
        }
        function handleDragOver(e) {
            e.preventDefault();
        }
        function handleDrop(e) {
            e.preventDefault();
            if (this === draggedRow) return;
            const fromId = draggedRow.getAttribute('data-id');
            const toId = this.getAttribute('data-id');
            const fromIndex = appData.monitoria.findIndex(i => i.id == fromId);
            const toIndex = appData.monitoria.findIndex(i => i.id == toId);
            if (fromIndex !== -1 && toIndex !== -1) {
                const [moved] = appData.monitoria.splice(fromIndex, 1);
                appData.monitoria.splice(toIndex, 0, moved);
                saveData();
                renderMonitoria();
            }
        }

        function addMonitoriaPosto() {
            const newId = Date.now() + '' + Math.floor(Math.random() * 1000);
            appData.monitoria.push({ id: newId, posto: 'Novo Posto', aluno: '', turma: '' });
            renderMonitoria();
            saveData();
            showToast('Posto adicionado!', 'success');
        }

        function deleteMonitoriaPosto(id) {
            if (!confirm('Excluir este posto?')) return;
            appData.monitoria = appData.monitoria.filter(i => i.id != id);
            renderMonitoria();
            saveData();
            showToast('Posto removido!', 'warning');
        }

        function saveMonitoriaPosto(id) {
            const item = appData.monitoria.find(i => i.id == id);
            if (!item) return;
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return;
            item.posto = row.querySelector('.posto-input').value.trim();
            item.aluno = row.querySelector('.aluno-input').value.trim();
            item.turma = row.querySelector('.turma-mon-input').value.trim().toUpperCase();
            saveData();
            showToast('Posto atualizado!', 'success');
        }

        function saveAllMonitoria() {
            appData.monitoria.forEach(item => {
                const row = document.querySelector(`tr[data-id="${item.id}"]`);
                if (row) {
                    item.posto = row.querySelector('.posto-input').value.trim();
                    item.aluno = row.querySelector('.aluno-input').value.trim();
                    item.turma = row.querySelector('.turma-mon-input').value.trim().toUpperCase();
                }
            });
            saveData();
            showToast('Todos os postos foram salvos!', 'success');
        }

        // ==================== UTILIT√ÅRIOS ====================
        function toggleDarkMode() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark', darkMode);
            localStorage.setItem('darkMode', darkMode);
            document.getElementById('darkModeBtn').innerText = darkMode ? '‚òÄÔ∏è' : 'üåô';
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('sge_logged_user');
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('sys-header').style.display = 'none';
            document.getElementById('app-content').style.display = 'none';
            // Limpa campos de login
            document.getElementById('login-email').value = '';
            document.getElementById('login-pass').value = '';
            showToast('Voc√™ saiu do sistema.', 'info');
        }

        // Inicializa√ß√£o
        (function init() {
            loadData();
            if (darkMode) {
                document.body.classList.add('dark');
                document.getElementById('darkModeBtn').innerText = '‚òÄÔ∏è';
            }
            // Cria datalists
            const turmasDatalist = document.createElement('datalist');
            turmasDatalist.id = 'turmas-list';
            CONFIG.turmasValidas.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                turmasDatalist.appendChild(opt);
            });
            document.body.appendChild(turmasDatalist);

            // Cria datalist vazio para professores (apenas para evitar erro no console)
            const profDatalist = document.createElement('datalist');
            profDatalist.id = 'professores-list';
            document.body.appendChild(profDatalist);
        })();

        // Atalho de teclado Ctrl+S
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                const activeSection = document.querySelector('.section.active')?.id;
                if (activeSection === 'sec-reservas') saveAllReservations();
                else if (activeSection === 'sec-monitoria') saveAllMonitoria();
            }
        });
    </script>
</body>
</html>